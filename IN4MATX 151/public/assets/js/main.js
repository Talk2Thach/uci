// Generated by CoffeeScript 1.10.0
(function() {
  $(document).ready(function() {
    var address, geolocation, get_food, navigation_url;
    geolocation = null;
    navigation_url = function(address) {
      if ('[object Array]' === Object.prototype.toString.call(address)) {
        address = address.join(", ");
      }
      address = address.replace(/\ /g, "+");
      if (/iPhone|iPod|iPad|Mac/.test(navigator.platform)) {
        return "https://maps.apple.com/?daddr=" + address;
      } else {
        return "https://maps.google.com/maps?daddr=" + address;
      }
    };
    get_food = function(open) {
      if (open == null) {
        open = false;
      }
      if (!geolocation) {
        alert("We cannot detect your current location.\nPlease enter the location!");
        return;
      }
      $.get('/food', {
        geolocation: geolocation.lat + "," + geolocation.lng
      }, function(data) {
        var business, container, h1, img, map_link, yelp_link;
        $("#container").empty();
        if (data.businesses) {
          business = data.businesses[0];
          container = document.getElementById("container");
          img = document.createElement("img");
          img.className = "restaurant";
          img.alt = business.id;
          img.src = business.image_url.replace("/ms.", "/l.");
          container.appendChild(img);
          h1 = document.createElement("h1");
          h1.appendChild(document.createTextNode(business.name));
          container.appendChild(h1);
          yelp_link = document.createElement("a");
          yelp_link.href = business.url;
          yelp_link.appendChild(document.createTextNode("Yelp"));
          container.appendChild(yelp_link);
          container.appendChild(document.createTextNode(", "));
          map_link = document.createElement("a");
          map_link.href = navigation_url(business.location.display_address);
          map_link.appendChild(document.createTextNode("Map"));
          container.appendChild(map_link);
          if (open) {
            document.location.href = yelp_link.href;
          }
        }
      });
    };
    address = document.getElementById('address');
    new google.maps.places.Autocomplete(address, {
      types: ['geocode']
    }).addListener('place_changed', function() {
      geolocation = {
        lat: this.getPlace().geometry.location.lat(),
        lng: this.getPlace().geometry.location.lng()
      };
      get_food();
    });
    google.maps.event.addDomListener(address, 'keydown', function(event) {
      if (event.keyCode === 13) {
        event.preventDefault();
      }
    });
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        geolocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
      }, function() {
        "Failed to get a location.";
      }, {
        enableHighAccuracy: true
      });
    }
    $("#randomize").click(function(event) {
      event.preventDefault();
      get_food();
    });
    $("#randomize-open").click(function(event) {
      event.preventDefault();
      get_food(true);
    });
  });

}).call(this);
